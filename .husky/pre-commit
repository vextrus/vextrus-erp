#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit quality gates
# Runs: lint-staged (format + lint), type check, tests

echo "🔍 Running pre-commit quality gates..."

# Run lint-staged (format + lint changed files)
npx lint-staged

# Type check
echo "📝 Type checking..."
pnpm build --no-emit 2>&1 || {
  echo "❌ TypeScript errors found. Fix before committing."
  exit 1
}

# Run tests (if test files changed)
CHANGED_FILES=$(git diff --cached --name-only)
if echo "$CHANGED_FILES" | grep -qE "\.spec\.ts$|\.test\.ts$"; then
  echo "🧪 Running tests..."
  npm test --bail --findRelatedTests || {
    echo "❌ Tests failed. Fix before committing."
    exit 1
  }
fi

echo "✅ Pre-commit checks passed!"
